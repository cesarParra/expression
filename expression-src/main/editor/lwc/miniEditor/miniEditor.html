<template>
  <lightning-card>
    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
      <div class="slds-col slds-text-body_small slds-text-title_bold pl-2">{title}</div>
      <div class="slds-col slds-grid slds-grid_align-end slds-gutters_x-small">
        <template lwc:if={enableValidation}>
          <div class="slds-col" style="width: 300px;">
            <lightning-input type="text"
                             value={recordId}
                             onchange={handleRecordIdChange}
                             placeholder="Record Id for validation (optional)"
                             variant="label-hidden"
                             class="compact-input"
            ></lightning-input>
          </div>
        </template>
        <template lwc:if={showValidationButton}>
          <div class="slds-col">
            <lightning-button variant="brand" label="Validate"
                              onclick={handleValidate}
                              icon-name="utility:play"
            ></lightning-button>
          </div>
        </template>
        <div class="slds-col">
          <lightning-button variant="brand-outline" label="Save"
                            onclick={handleExpressionSaved}
          ></lightning-button>
        </div>
      </div>
    </div>
    <div class="pt-1">
      <template lwc:if={displayAsTextareaVariant}>
        <textarea name="expression"
                  onkeyup={handleExpressionChange}
                  class="unstyled-input p-2 mono" placeholder={placeholder} value={expression}>
          {expression}
        </textarea>
      </template>
      <template lwc:if={displayAsInput}>
        <input type="text" name="expression"
               onkeyup={handleExpressionChange}
               class="unstyled-input p-2 mono" placeholder={placeholder} value={expression}/>
      </template>
      <template lwc:if={displayAsEditor}>
        <iframe src={iframeUrl}
                scrolling="no" style="width: 100%; height: 100%; overflow: hidden; border: none"
                onload={iframeLoaded}
        ></iframe>
      </template>
    </div>
    <hr/>
    <div class="mb-1">
      <div class="flex">
        <div class="pl-2 pt-2 pr-4 w-48 min-w-48 max-h-72 overflow-y-scroll">
          <ul class="list-none px-0">
            <template for:each={displayFunctions} for:item="category">
              <li class="truncate pt-1" key={category.category}>
                <span class="text-sm text-gray-600 font-semibold">{category.category}</span>
                <ul class="list-none px-0">
                  <template for:each={category.values} for:item="value">
                    <li class="py-0.5" key={value.name}>
                      <a class="no-underline text-gray-600 hover:text-blue-500 text-sm"
                         href="#"
                         data-name={value.name}
                         onmouseenter={handleMouseEnter}
                         onclick={handleFunctionClick}
                      >
                        {value.name}
                      </a>
                    </li>
                  </template>
                </ul>
              </li>
            </template>
          </ul>
        </div>
        <div class="border-l border-gray-200"></div>
        <div class="px-4 pt-2 max-h-72 overflow-y-scroll flex-1">
          <template lwc:if={lastHoveredFunction}>
            <div>
              <p class="font-bold">{lastHoveredFunction.name}</p>
              <lightning-formatted-rich-text value={lastHoveredFunction.description}></lightning-formatted-rich-text>
              <div class="mt-2">
                <template lwc:if={lastHoveredFunction.examples}>
                  <div><strong>Examples</strong></div>
                  <pre>
                    <template for:each={lastHoveredFunction.examples} for:item="example">
                      <div key={example}>
                        {example}
                      </div>
                    </template>
                  </pre>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
    <template lwc:if={showResults}>
      <hr/>
      <div class="pt-1">
        <lightning-tabset>
          <lightning-tab label="Result">
            <template for:each={result.payload} for:item="payload">
              <div key={payload.message}>
                <lightning-badge label={payload.type}></lightning-badge>
                <pre class={resultColor}>
                  <lightning-formatted-rich-text value={payload.message}></lightning-formatted-rich-text>
                </pre>
                <hr/>
              </div>
            </template>
          </lightning-tab>
          <lightning-tab label="Diagnostics">
            <ul>
              <li><strong>CPU Time (ms):</strong> {diagnostics.cpuTime}</li>
              <li><strong>DML Statements:</strong> {diagnostics.dmlStatements}</li>
              <li><strong>Queries:</strong> {diagnostics.queries}</li>
              <li><strong>Query Rows:</strong> {diagnostics.queryRows}</li>
            </ul>
          </lightning-tab>
          <lightning-tab label="AST">
            <pre class={resultColor}>
              <lightning-formatted-rich-text value={ast}></lightning-formatted-rich-text>
            </pre>
          </lightning-tab>
        </lightning-tabset>
      </div>
    </template>
  </lightning-card>
</template>
